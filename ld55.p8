pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
minions={}
towers={}
shake=0
t=0

function _init()
	reset_game()
end

function _draw()
	cls()
	draw_screenshake()
	
	foreach(minions,draw_minion)
	foreach(towers,draw_tower)
	
	draw_floor(80)
end

function _update()
	t+=1
	
	foreach(minions,update_minion)
	foreach(towers,update_tower)
	--collisions
	minions_vs_minions()
end

function reset_game()
	minions={}
	t=0
	shake=0
	
	spawn_tower(0)
	spawn_tower(112)
	
	spawn_minion(0,80,1)
	spawn_minion(128,80,-1)
end
-->8
-- minions
function spawn_minion(x,y,dir)
	local m={
		x=x,
		y=y,
		offset_x=0,
		t=0,
		dir=dir,
		life=3,
		atk=0,
		atk_ratio=30,
		versus=0,
		status="move",
		flash=0,
		kind="small"}

	m.img=spr_for_minion(m)
	m.size=size_for_minion(m)
	
	add(minions,m)
	
	return m
end

function draw_minion(m)
	local frame=(m.t/10)%2
	local img=spr_for_minion(m)+frame
	local flipx=m.dir<0

	if m.flash>0 then
		for i=1,15 do pal(i,7) end
	end
	
	local x=m.x+m.offset_x
	
	spr(img,x-4,m.y-8,1,1,flipx)
	pal()
end

function spr_for_minion(m)
	if m.kind=="small" and is_ally(m) then
		return 1
	elseif m.kind=="small" and is_baddie(m) then
		return 32
	end
	
	return nil
end

function size_for_minion(m)
	if m.kind=="small" then
		return 10
	end
	
	return 4
end

function update_minion(m)
	m.t+=1
	m.flash=max(0,m.flash-1)
	
	if m.status=="move" then
		update_minion_move(m)
	elseif m.status=="attack" then
		update_minion_attack(m)
	end
end

function update_minion_move(m)
		m.x+=m.dir
		
		if m.x>=124 and is_ally(m) then
			hit_baddie_tower(m)
			del(minions,m)
		elseif m.x<=4 and is_baddie(m)then
			hit_ally_tower(m)
			del(minions,m)
		end
end

function update_minion_attack(m)
		m.atk-=1
		m.offset_x=(m.atk/10)*m.dir
		if m.atk<=0 then
			m.atk=m.atk_ratio
			local did_kill=hit_minion(m.versus)
			
			if did_kill then
				m.versus=nil
				m.status="move"
			end
		end
end

function is_baddie(m)
	return m.dir<0
end

function is_ally(m)
	return m.dir>0
end

function minions_vs_minions()
	for m in all(minions) do
		for other in all(minions) do
			if is_collision_minion_vs_minion(m,other) then
				attack_minion(m,other)
			end
		end
	end
end

function is_collision_minion_vs_minion(m,other)
	-- avoid collision with themselves
	if m==other then
		return false
	end
	
	-- check if collision with enemies
	local are_enemies=m.dir!=other.dir
	local diff=abs(m.x-other.x)
	if diff<m.size and are_enemies then
		return true
	end
	
	return false
end

function attack_minion(m,other)
	if m.status=="attack" then
		return
	end
	
	m.status="attack"
	m.versus=other
	m.atk=rnd(m.atk_ratio)
end

function hit_minion(m)
	m.flash=8
	m.life-=1
	
	if m.life<=0 then
		del(minions,m)
		return true
	end
	
	return false
end

function hit_ally_tower(m)
	hit_tower(towers[1],1)
end

function hit_baddie_tower(m)
	hit_tower(towers[2],1)
end

-->8
-- hud and attrezo

function draw_floor(y)
	map(0,0,0,y,16,2)
end

-- towers ------------

function draw_tower(t)
	if t.flash>0 then
		for i=1,15 do pal(i,7) end
	end
	
	local flipx=t.x>64
	spr(64,t.x,64,2,2,flipx)
	pal()
end

function update_tower(t)
	t.flash=max(0,t.flash-1)
end


function spawn_tower(x)
	local t={
		x=x,
		life=1,
		flash=0
	}
	
	add(towers,t)
	
	return t
end

function hit_tower(t,dmg)
	t.flash=3
	t.life-=1
	
	screenshake()
end
-->8
-- utils

function screenshake(str)
	if str==nil then
		str=6
	end
	
	shake=6
end

function draw_screenshake()
	local sx=rnd(shake)-shake/2
	local sy=rnd(shake)-shake/2
	
	shake=max(shake-0.5,0)
	if shake>10 then
		shake*=0.9
	end
	
	camera(sx,sy)
end
__gfx__
00000000000000000000000000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000101010001010100000000000000000000000000000000000000000000000000
00700700000000000080080000000000000000000000000000000000000000001001000101010000000000000000000000000000000000000000000000000000
00077000008008000088880000000000000000000000000000000000000000000000000100010000000000000000000000000000000000000000000000000000
00077000008888000081810000000000000000000000000000000000000000000001000000001000000000000000000000000000000000000000000000000000
00700700008181000088880000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000
00000000008888000002200000000000000000000000000000000000000000000000010000100000000000000000000000000000000000000000000000000000
00000000002002000002200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000c00c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00c00c0000cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc0000c1c1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00c1c10000cccc000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00cccc00000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00100100000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd0dd0dd0dd0dd0d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dd5dd5dd5dd5dd5d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddddddddddddddd0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555555100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55555555555551000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddddddddddd1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
555dddddddddd1000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
55dddddd66dd10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddddd5661100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
ddddddd55d1600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
66dddddddd1060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
6655dddddd1006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
d555dddddd1000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddddddddd1000066000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
dddddddddd1444444400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0808080908090808080809090908080800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
